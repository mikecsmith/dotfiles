#!/usr/bin/env bash
set -euo pipefail

OS="$(uname -s)"
ARCH="$(uname -m)"

echo "üîç Detected OS: $OS, Arch: $ARCH"

if [[ "$OS" == "Darwin" ]]; then
  if [[ "$ARCH" == "arm64" ]]; then
    FILENAME="nvim-macos-arm64.tar.gz"
  else
    FILENAME="nvim-macos-x86_64.tar.gz"
  fi
elif [[ "$OS" == "Linux" ]]; then
  if [[ "$ARCH" == "aarch64" ]]; then
    FILENAME="nvim-linux-arm64.tar.gz"
  else
    FILENAME="nvim-linux-x86_64.tar.gz"
  fi
else
  echo "‚ùå Unsupported OS: $OS"
  exit 1
fi

URL="https://github.com/neovim/neovim/releases/download/nightly/$FILENAME"
TMP="$(mktemp -d)"
TAR="$TMP/$FILENAME"
INSTALL_DIR="$HOME/.local/nvim"
BIN_DIR="$HOME/.local/bin"
NVIM_BIN="$BIN_DIR/nvim"

echo "‚è≥ Downloading Neovim nightly ($FILENAME)..."

cd "$TMP"

if ! curl -fL -o "$TAR" "$URL"; then
  echo "‚ùå Download failed! The URL might be wrong or the server is down."
  echo "   Attempted URL: $URL"
  rm -rf "$TMP"
  exit 1
fi

if [[ "$OS" == "Darwin" ]]; then
  echo "üçé macOS detected: Clearing quarantine attributes..."
  xattr -rc "$TAR" 2>/dev/null || true
fi

echo "üì¶ Extracting..."
tar -xzf "$TAR"

EXDIR="$(find "$TMP" -maxdepth 1 -type d -name 'nvim-*' -print -quit)"

if [ -z "$EXDIR" ]; then
  echo "‚ùå Extraction failed: Could not find extracted folder."
  rm -rf "$TMP"
  exit 1
fi

echo "üîÑ Installing to $INSTALL_DIR..."
rm -rf "$INSTALL_DIR"
mv "$EXDIR" "$INSTALL_DIR"

mkdir -p "$BIN_DIR"
if [ -L "$NVIM_BIN" ] || [ -e "$NVIM_BIN" ]; then
  rm -f "$NVIM_BIN"
fi
ln -s "$INSTALL_DIR/bin/nvim" "$NVIM_BIN"
chmod +x "$INSTALL_DIR/bin/nvim"

if [[ "$OS" == "Darwin" ]]; then
  echo "üîê macOS detected: Ad-hoc signing binaries..."

  codesign -s - -f --entitlements /dev/null "$INSTALL_DIR/bin/nvim"

  if [ -d "$INSTALL_DIR/lib" ]; then
    find "$INSTALL_DIR/lib" -name "*.dylib" -exec codesign -s - -f {} + 2>/dev/null
  fi

  if [ -d "$INSTALL_DIR/lib/nvim/parser" ]; then
    find "$INSTALL_DIR/lib/nvim/parser" -name "*.so" -exec codesign -s - -f {} + 2>/dev/null
  fi
fi

rm -rf "$TMP"

echo "‚úÖ Neovim nightly installed successfully!"
echo "‚Üí Location: $INSTALL_DIR"
echo "‚Üí Binary:   $NVIM_BIN"

if [[ ":$PATH:" != *":$BIN_DIR:"* ]]; then
  echo ""
  echo "‚ö†Ô∏è  WARNING: $BIN_DIR is NOT in your PATH."
  echo "   Add this to your shell config (~/.bashrc or ~/.zshrc):"
  echo "   export PATH=\"$BIN_DIR:\$PATH\""
fi
