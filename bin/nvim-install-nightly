#!/usr/bin/env bash
set -euo pipefail

URL="https://github.com/neovim/neovim/releases/download/nightly/nvim-macos-arm64.tar.gz"
TMP="$(mktemp -d)"
TAR="$TMP/nvim.tar.gz"
INSTALL_DIR="$HOME/.local/nvim"
BIN_DIR="$HOME/.local/bin"
NVIM_BIN="$BIN_DIR/nvim"

echo "â³ Downloading Neovim nightly..."
cd "$TMP"
curl -sL -o "$TAR" "$URL"

# 1. Strip quarantine flags before extraction
xattr -rc "$TAR" 2>/dev/null || true

echo "ðŸ“¦ Extracting..."
tar -xzf "$TAR"
EXDIR="$(find "$TMP" -maxdepth 1 -type d -name 'nvim*' -print -quit)"
[ -n "$EXDIR" ] || {
  echo "Extraction failed"
  rm -rf "$TMP"
  exit 1
}

# Clean old install
rm -rf "$INSTALL_DIR"
mv "$EXDIR" "$INSTALL_DIR"

# Ensure ~/.local/bin exists and symlink
mkdir -p "$BIN_DIR"
ln -sf "$INSTALL_DIR/bin/nvim" "$NVIM_BIN"
chmod +x "$INSTALL_DIR/bin/nvim"

# --- NEW: SECURITY & SIGNING STEP ---
echo "ðŸ” Ad-hoc signing Neovim and its internal libraries..."

# 2. Sign the main binary
codesign -s - -f --entitlements /dev/null "$INSTALL_DIR/bin/nvim"

# 3. Sign bundled shared libraries (critical for loading parsers)
if [ -d "$INSTALL_DIR/lib" ]; then
  find "$INSTALL_DIR/lib" -name "*.dylib" -exec codesign -s - -f {} + 2>/dev/null
fi

# 4. Sign bundled tree-sitter parsers if they exist in the bundle
if [ -d "$INSTALL_DIR/lib/nvim/parser" ]; then
  find "$INSTALL_DIR/lib/nvim/parser" -name "*.so" -exec codesign -s - -f {} + 2>/dev/null
fi
# ------------------------------------

# Clean up
rm -rf "$TMP"

echo "âœ… Neovim nightly installed and signed successfully!"
echo "â†’ Binary: $NVIM_BIN"
